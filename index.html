<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Desenho com a M√£o ‚Äî Bootstrap Edition</title>

<!-- Bootstrap CSS + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body {
    background: #0a0f1a;
    color: #e9f2ff;
    font-family: 'Inter', system-ui, sans-serif;
    overflow: hidden;
  }
  .app {
    display: flex;
    height: 100vh;
    padding: 16px;
    gap: 16px;
  }
  .stage {
    flex: 1;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
  }
  video, canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  video { transform: scaleX(1); }
  canvas { pointer-events: none; }
  .panel {
    width: 360px;
    backdrop-filter: blur(8px);
    background: rgba(15,20,40,0.7);
    border-radius: 14px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .status-box {
    position: absolute;
    left: 10px;
    bottom: 10px;
    background: rgba(0,0,0,0.5);
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 13px;
  }
  #errorBox {
    position: absolute;
    left: 10px;
    top: 10px;
    background: rgba(120,0,0,0.7);
    padding: 8px 12px;
    border-radius: 6px;
    color: #ffdede;
    display: none;
  }
</style>
</head>
<body>

<div class="app">
  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="draw"></canvas>
    <canvas id="hud"></canvas>
    <div id="errorBox"></div>
    <div class="status-box">Status: <span id="status">Iniciando...</span></div>
  </div>

  <div class="panel">
    <h5><i class="bi bi-hand-index-thumb me-2"></i>Desenho com a M√£o</h5>

    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small">Cor:</label>
      <input id="color" class="form-control form-control-color" type="color" value="#7dd3fc" style="width:60px">
    </div>

    <div>
      <label class="form-label small mb-1">Espessura: <span id="thickVal">8</span>px</label>
      <input id="thickness" type="range" min="2" max="50" value="8" class="form-range">
    </div>

    <div class="form-check form-switch">
      <input class="form-check-input" id="pinchToggle" type="checkbox" checked>
      <label class="form-check-label small" for="pinchToggle">Pin√ßar para desenhar</label>
    </div>

    <div class="form-check form-switch">
      <input class="form-check-input" id="mirrorToggle" type="checkbox" checked>
      <label class="form-check-label small" for="mirrorToggle">Espelhar X</label>
    </div>

    <div class="btn-group flex-wrap">
      <button id="eraser" class="btn btn-outline-light btn-sm"><i class="bi bi-eraser"></i> Borracha</button>
      <button id="clear" class="btn btn-outline-light btn-sm"><i class="bi bi-trash"></i> Limpar</button>
      <button id="save" class="btn btn-outline-light btn-sm"><i class="bi bi-download"></i> Salvar</button>
    </div>

    <small class="text-muted mt-auto">
      üí° Use pin√ßa (polegar + indicador) para desenhar.  
      Se quiser desenhar livremente, desative a op√ß√£o ‚ÄúPin√ßar‚Äù.
    </small>
  </div>
</div>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const video = document.getElementById('video');
const drawCanvas = document.getElementById('draw');
const hudCanvas = document.getElementById('hud');
const ctx = drawCanvas.getContext('2d');
const hud = hudCanvas.getContext('2d');

const colorEl = document.getElementById('color');
const thicknessEl = document.getElementById('thickness');
const thickVal = document.getElementById('thickVal');
const pinchToggle = document.getElementById('pinchToggle');
const mirrorToggle = document.getElementById('mirrorToggle');
const eraserBtn = document.getElementById('eraser');
const clearBtn = document.getElementById('clear');
const saveBtn = document.getElementById('save');
const statusEl = document.getElementById('status');
const errorBox = document.getElementById('errorBox');

let erasing = false;
let prevPoint = null;
let cameraObj = null;
let camStarted = false;

// Atualiza espessura
thicknessEl.addEventListener('input', ()=> thickVal.textContent = thicknessEl.value);
eraserBtn.addEventListener('click', ()=> {
  erasing = !erasing;
  eraserBtn.classList.toggle('btn-primary', erasing);
});
clearBtn.addEventListener('click', ()=> ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height));
saveBtn.addEventListener('click', ()=>{
  const link = document.createElement('a');
  link.download = 'desenho.png';
  link.href = drawCanvas.toDataURL('image/png');
  link.click();
});

function resizeCanvas(){
  drawCanvas.width = hudCanvas.width = video.clientWidth;
  drawCanvas.height = hudCanvas.height = video.clientHeight;
}
window.addEventListener('resize', resizeCanvas);

function showError(msg){
  errorBox.textContent = msg;
  errorBox.style.display = 'block';
  setTimeout(()=> errorBox.style.display='none',5000);
}

// Fun√ß√£o principal
async function initCameraAndHands(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    video.onloadedmetadata = async ()=>{
      resizeCanvas();
      camStarted = true;
      statusEl.textContent = 'C√¢mera ativa ‚úÖ';

      const hands = new Hands({
        locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });
      hands.setOptions({
        maxNumHands:1,
        modelComplexity:1,
        minDetectionConfidence:0.7,
        minTrackingConfidence:0.7
      });
      hands.onResults(onResults);

      const camera = new Camera(video, {
        onFrame: async()=> { await hands.send({image: video}); },
        width: video.videoWidth,
        height: video.videoHeight
      });
      camera.start();
      cameraObj = camera;
    };
  }catch(err){
    console.error(err);
    showError('‚ö†Ô∏è C√¢mera bloqueada ou n√£o detectada');
    statusEl.textContent = 'C√¢mera bloqueada ‚ùå';
  }
}

function onResults(results){
  hud.clearRect(0,0,hudCanvas.width,hudCanvas.height);
  if(!results.multiHandLandmarks || results.multiHandLandmarks.length===0){ prevPoint=null; return; }

  const lm = results.multiHandLandmarks[0];
  const tip = lm[8];
  let x = tip.x * drawCanvas.width;
  const y = tip.y * drawCanvas.height;
  if(mirrorToggle.checked) x = drawCanvas.width - x;

  const thumb = lm[4];
  let drawNow = true;
  if(pinchToggle.checked){
    const d = Math.hypot(tip.x - thumb.x, tip.y - thumb.y);
    drawNow = d < 0.05;
  }

  // HUD dot
  hud.beginPath();
  hud.arc(x, y, 10, 0, Math.PI*2);
  hud.fillStyle = 'rgba(100,200,255,0.2)';
  hud.fill();
  hud.strokeStyle = 'rgba(120,220,255,0.5)';
  hud.stroke();

  if(drawNow){
    if(prevPoint){
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = erasing ? 'rgba(0,0,0,1)' : colorEl.value;
      ctx.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
      ctx.lineWidth = Number(thicknessEl.value);
      ctx.beginPath();
      ctx.moveTo(prevPoint.x, prevPoint.y);
      ctx.lineTo(x, y);
      ctx.stroke();
    }
    prevPoint = {x,y};
  } else prevPoint = null;
}

initCameraAndHands();
</script>
</body>
</html>
