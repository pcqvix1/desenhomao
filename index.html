<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HandDraw Pro — Profissional</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root{
  --bg-dark: #071226;
  --glass: rgba(12,18,30,0.6);
  --accent: #7dd3fc;
  --muted: #9fb9da;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-dark),#020617);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef8}
.app{display:flex;gap:16px;height:100vh;padding:18px}
.stage{flex:1;position:relative;border-radius:12px;overflow:hidden;background:#000;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.02) saturate(1.05);transform:scaleX(-1);}
canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
.panel{width:380px;backdrop-filter:blur(8px);background:var(--glass);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px}
.title{font-weight:700;font-size:18px}
.status{font-size:13px;color:var(--muted)}
.hud-dot{position:absolute;width:26px;height:26px;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none}
.small{font-size:13px}
.controls .btn{min-width:110px}
.toggle-theme{cursor:pointer}
.neon { filter: drop-shadow(0 0 8px rgba(125,211,252,0.22)) drop-shadow(0 0 12px rgba(125,211,252,0.08)); }
@media(max-width:920px){.panel{width:300px}}
</style>
</head>
<body>
<div class="app">
  <div class="stage" id="stage">
    <video id="cam" autoplay playsinline muted></video>
    <canvas id="draw" class="neon"></canvas>
    <canvas id="hud"></canvas>

    <div style="position:absolute;left:12px;bottom:12px;z-index:50;background:rgba(0,0,0,0.45);padding:8px;border-radius:8px">
      <span class="small">Status:</span> <strong id="statusText">Iniciando...</strong>
    </div>

    <div id="errorBox" style="position:absolute;left:12px;top:12px;z-index:60;background:#3b1414;color:#ffdede;padding:8px;border-radius:8px;display:none"></div>
  </div>

  <div class="panel">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <div class="title"><i class="bi bi-brush"></i> HandDraw Pro</div>
        <div class="status">Desenho por movimento da mão — avançado</div>
      </div>
      <div class="d-flex gap-2">
        <button id="mobileLinkBtn" class="btn btn-sm btn-outline-light" title="Ir para versão móvel"><i class="bi bi-phone"></i></button>
        <button id="themeToggle" class="btn btn-sm btn-outline-light" title="Alternar tema"><i class="bi bi-circle-half"></i></button>
      </div>
      </div>

    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="form-label small mb-0">Cor</label>
        <input id="color" type="color" class="form-control form-control-color" value="#7dd3fc" style="width:64px;height:40px;padding:0">
      </div>
      <div class="col">
        <label class="form-label small mb-0">Tamanho: <span id="thickVal">8</span>px</label>
        <input id="thickness" type="range" class="form-range" min="1" max="120" value="8">
      </div>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <div class="form-check form-switch">
        <input id="pinchToggle" class="form-check-input" type="checkbox" checked>
        <label class="form-check-label small" for="pinchToggle">Pinçar para desenhar</label>
      </div>
      </div>

    <div class="controls d-flex gap-2 flex-wrap">
      <button id="eraserBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-eraser"></i> Borracha</button>
      <button id="undoBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-arrow-counterclockwise"></i> Undo</button>
      <button id="redoBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-arrow-clockwise"></i> Redo</button>
      <button id="clearBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-trash"></i> Limpar</button>
      <button id="savePngBtn" class="btn btn-primary btn-sm"><i class="bi bi-download"></i> Salvar PNG</button>
      <button id="saveSvgBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-filetype-svg"></i> Exportar SVG</button>
      <button id="replayBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-play-fill"></i> Replay</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// URL para a versão móvel (SUBSTITUIR PELO TEU ENDEREÇO REAL!)
const URL_VERSAO_MOVEL = 'https://pcqvix1.github.io/mobile/'; 

const video = document.getElementById('cam');
const drawCanvas = document.getElementById('draw');
const hudCanvas = document.getElementById('hud');
const ctx = drawCanvas.getContext('2d',{alpha:true});
const hud = hudCanvas.getContext('2d',{alpha:true});
const statusText = document.getElementById('statusText');
const colorEl = document.getElementById('color');
const thicknessEl = document.getElementById('thickness');
const thickVal = document.getElementById('thickVal');
const pinchToggle = document.getElementById('pinchToggle');
// const mirrorToggle = document.getElementById('mirrorToggle'); // Variável REMOVIDA
const eraserBtn = document.getElementById('eraserBtn');
const undoBtn = document.getElementById('undoBtn');
const redoBtn = document.getElementById('redoBtn');
const clearBtn = document.getElementById('clearBtn');
const savePngBtn = document.getElementById('savePngBtn');
const saveSvgBtn = document.getElementById('saveSvgBtn');
const replayBtn = document.getElementById('replayBtn');
const themeToggle = document.getElementById('themeToggle');
const mobileLinkBtn = document.getElementById('mobileLinkBtn'); // NOVA VARIÁVEL (Botão 3)

let running=true, erasing=false, prevHud=null, currentStroke=null;
let strokes=[], undoStack=[], redoStack=[];
let lastTime=0, darkTheme=true;

/* Resize */
function resizeCanvases(){
  const rect = drawCanvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio||1;
  drawCanvas.width = hudCanvas.width = Math.floor(rect.width*ratio);
  drawCanvas.height = hudCanvas.height = Math.floor(rect.height*ratio);
  ctx.setTransform(ratio,0,0,ratio,0,0);
  hud.setTransform(ratio,0,0,ratio,0,0);
}
window.addEventListener('resize',resizeCanvases);

/* UI */
thicknessEl.addEventListener('input',()=> thickVal.textContent=thicknessEl.value);
eraserBtn.addEventListener('click',()=>{
  erasing=!erasing;
  eraserBtn.classList.toggle('btn-primary', erasing);
  eraserBtn.innerHTML=erasing?'<i class="bi bi-brush"></i> Desenhar':'<i class="bi bi-eraser"></i> Borracha';
});
clearBtn.addEventListener('click',()=>{
  pushHistory();
  ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  strokes.length=0;
});
undoBtn.addEventListener('click',undoAction);
redoBtn.addEventListener('click',redoAction);
savePngBtn.addEventListener('click',savePNG);
saveSvgBtn.addEventListener('click',exportSVG);
// Chamada da nova função de Replay
replayBtn.addEventListener('click',()=>replayStrokes(strokes, drawCanvas));
themeToggle.addEventListener('click',toggleTheme);
// NOVO EVENTO: Redirecionar para o site móvel
mobileLinkBtn.addEventListener('click', () => {
  window.location.href = URL_VERSAO_MOVEL;
});

/* History */
function pushHistory(){
  if(undoStack.length>=20) undoStack.shift();
  undoStack.push(ctx.getImageData(0,0,drawCanvas.width,drawCanvas.height));
  redoStack.length=0;
}
function undoAction(){ if(!undoStack.length) return; redoStack.push(ctx.getImageData(0,0,drawCanvas.width,drawCanvas.height)); ctx.putImageData(undoStack.pop(),0,0);}
function redoAction(){ if(!redoStack.length) return; undoStack.push(ctx.getImageData(0,0,drawCanvas.width,drawCanvas.height)); ctx.putImageData(redoStack.pop(),0,0);}

/* Save */
function savePNG(){ const link=document.createElement('a'); link.href=drawCanvas.toDataURL('image/png'); link.download='handdraw.png'; link.click();}
function exportSVG(){
  const w=drawCanvas.width, h=drawCanvas.height;
  let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><rect width="100%" height="100%" fill="none"/>`;
  for(const s of strokes){
    if(!s.points || s.points.length<2) continue;
    const pointsAttr = s.points.map(p=>`${p.x},${p.y}`).join(' ');
    const color = s.eraser?'#000000':s.color;
    svg+=`<polyline points="${pointsAttr}" fill="none" stroke="${color}" stroke-width="${s.width}" stroke-linecap="round" stroke-linejoin="round"/>`;
  }
  svg+='</svg>';
  const blob=new Blob([svg],{type:'image/svg+xml'}), url=URL.createObjectURL(blob);
  const link=document.createElement('a'); link.href=url; link.download='handdraw.svg'; link.click();
}

/* Replay (2: Função corrigida) */
async function replayStrokes(strokes, drawCanvas) {
  if(!strokes || !strokes.length) return;

  const overlay = document.createElement('canvas');
  overlay.width = drawCanvas.width;
  overlay.height = drawCanvas.height;
  overlay.style.position = 'absolute';
  overlay.style.left = '0';
  overlay.style.top = '0';
  overlay.style.zIndex = 1000;

  const parent = drawCanvas.parentElement || document.body;
  parent.appendChild(overlay);

  const octx = overlay.getContext('2d');
  octx.lineCap = 'round';
  octx.lineJoin = 'round';

  const ctx = drawCanvas.getContext('2d');
  ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);

  for(const stroke of strokes){
    if(!stroke.points || stroke.points.length < 2) continue;

    for(let i=1; i < stroke.points.length; i++){
      const p0 = stroke.points[i-1];
      const p1 = stroke.points[i];

      octx.beginPath();
      octx.moveTo(p0.x, p0.y);
      octx.lineTo(p1.x, p1.y);
      octx.lineWidth = stroke.width;
      octx.strokeStyle = stroke.eraser ? 'rgba(0,0,0,1)' : stroke.color;
      octx.globalCompositeOperation = stroke.eraser ? 'destination-out' : 'source-over';
      octx.stroke();
      octx.globalCompositeOperation = 'source-over';

      await new Promise(r => setTimeout(r, 12));
    }
  }
  
  // CORREÇÃO: Transfere o desenho para o canvas principal.
  ctx.drawImage(overlay, 0, 0);

  // Remove overlay ao final
  overlay.remove();
}

/* Theme */
function toggleTheme(){
  darkTheme=!darkTheme;
  document.body.style.background=darkTheme?'linear-gradient(180deg,var(--bg-dark),#020617)':'#f0f0f0';
}

/* Drawing utils */
function addPointToStroke(stroke,pt){
  stroke.points.push(pt);
  if(stroke.points.length>=2){
    const p0=stroke.points[stroke.points.length-2];
    const p1=stroke.points[stroke.points.length-1];
    ctx.beginPath(); ctx.moveTo(p0.x,p0.y); ctx.lineTo(p1.x,p1.y);
    ctx.lineWidth=stroke.width; ctx.lineCap='round'; ctx.lineJoin='round';
    if(stroke.eraser){ ctx.globalCompositeOperation='destination-out'; ctx.strokeStyle='rgba(0,0,0,1)';}
    else{ ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=stroke.color;}
    ctx.stroke(); ctx.globalCompositeOperation='source-over';
  }
}

/* MediaPipe Hands */
async function initCameraAndHands(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});
    video.srcObject = stream;
    video.onloadedmetadata=()=>{
      resizeCanvases();
      setupHands();
      statusText.textContent='Pronto';
    };
  }catch(e){
    console.error(e);
    document.getElementById('errorBox').style.display='block';
    document.getElementById('errorBox').textContent='Erro ao acessar a câmera';
  }
}

function setupHands(){
  const hands = new Hands({locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.68, minTrackingConfidence:0.6});
  hands.onResults(onResults);

  const cam = new Camera(video,{onFrame:async()=>await hands.send({image:video}),width:video.videoWidth,height:video.videoHeight});
  cam.start();
}

function onResults(results){
  hud.clearRect(0,0,hudCanvas.width,hudCanvas.height);
  if(!results.multiHandLandmarks?.length){ prevHud=null; currentStroke=null; return; }
  const lm=results.multiHandLandmarks[0];
  let tip=lm[8], thumb=lm[4];
  let x = tip.x*drawCanvas.width, y = tip.y*drawCanvas.height;
  
  // 1: ESPELHAMENTO PERMANENTE (Sem botão de toggle)
  x = drawCanvas.width - x;

  if(!prevHud) prevHud={x,y};
  // SUAVIZAÇÃO ORIGINAL MANTIDA
  prevHud.x=prevHud.x*0.7+x*0.3; prevHud.y=prevHud.y*0.7+y*0.3;

  // Draw HUD dot
  hud.beginPath(); hud.arc(prevHud.x,prevHud.y,12,0,Math.PI*2);
  hud.fillStyle='rgba(125,211,252,0.18)'; hud.fill();
  hud.lineWidth=1.5; hud.strokeStyle='rgba(125,211,252,0.5)'; hud.stroke();

  // Pinch detection
  const d=Math.hypot(tip.x-thumb.x,tip.y-thumb.y);
  const drawNow = pinchToggle.checked ? d<0.055 : true;

  if(drawNow){
    const pt={x:prevHud.x,y:prevHud.y,t:performance.now()};
    if(!currentStroke){
      currentStroke={points:[],color:colorEl.value,width:Number(thicknessEl.value),eraser:erasing};
      strokes.push(currentStroke);
      pushHistory();
    }
    addPointToStroke(currentStroke,pt);
  }else currentStroke=null;
}

/* Init */
resizeCanvases();
initCameraAndHands();
</script>
</body>
</html>